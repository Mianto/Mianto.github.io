<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Refactoring to State Pattern | Siddhant Shaw</title><meta name=keywords content><meta name=description content="Refactoring is a process of changing a software in a way that doesn&rsquo;t alter the external behaviour of code and yet improve its internal structure. In this post I am trying to explain how one of the bad code smell can be treated using State Patterns."><meta name=author content="Siddhant Shaw"><link rel=canonical href=https://mianto.github.io/posts/refactoring-to-state-pattern/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://mianto.github.io/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://mianto.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://mianto.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://mianto.github.io/apple-touch-icon.png><link rel=mask-icon href=https://mianto.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Refactoring to State Pattern"><meta property="og:description" content="Refactoring is a process of changing a software in a way that doesn&rsquo;t alter the external behaviour of code and yet improve its internal structure. In this post I am trying to explain how one of the bad code smell can be treated using State Patterns."><meta property="og:type" content="article"><meta property="og:url" content="https://mianto.github.io/posts/refactoring-to-state-pattern/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-09T22:03:46+05:30"><meta property="article:modified_time" content="2022-08-09T22:03:46+05:30"><meta name=twitter:card content="summary"><meta name=twitter:title content="Refactoring to State Pattern"><meta name=twitter:description content="Refactoring is a process of changing a software in a way that doesn&rsquo;t alter the external behaviour of code and yet improve its internal structure. In this post I am trying to explain how one of the bad code smell can be treated using State Patterns."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://mianto.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Refactoring to State Pattern","item":"https://mianto.github.io/posts/refactoring-to-state-pattern/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Refactoring to State Pattern","name":"Refactoring to State Pattern","description":"Refactoring is a process of changing a software in a way that doesn\u0026rsquo;t alter the external behaviour of code and yet improve its internal structure. In this post I am trying to explain how one of the bad code smell can be treated using State Patterns.","keywords":[],"articleBody":"Refactoring is a process of changing a software in a way that doesn’t alter the external behaviour of code and yet improve its internal structure. Refactoring is just like performance optimization as both involve carrying out code manipulations that don’t change the overall functionality of the program. The difference is the purpose: Refactoring is always done to make the code easier to understand and cheaper to modify.\nRefactoring is generally done when there is tangible and observable indication that there is deeper problem in the system, these are called code smells. There is lot of code smell which includes Long Method, Large Class, which generally indicates method or class is doing more than single thing.\nIn this post, I am going to talk about one of the code smell Repeated Switches, and how it can be related to State design pattern. Repeat Switches occurs where the same conditional switching logic (either in a switch/case statement or in a cascade of if/else statements) pops up in different places. The problem with such duplicate switches is that, whenever a clause is added or needs to be updated, one have to find all the switches and update them.\nState Pattern State pattern allows an object to alter its behaviour when its internal state changes. The object will appear to change its class. State pattern is closely related to Finite state machines.\nThe main idea is that, at any given moment, there’s a finite number of states which a program can be in. Within any unique state, the program behaves differently, and the program can be switched from one state to another instantaneously. However, depending on a current state, the program may or may not switch to certain other states. These switching rules, called transitions, are also finite and predetermined.\nImplementing State Pattern Implementing a finite state machine involves series of steps:\nGather up all the states Define the states using a constants or enums and create an instance to hold the current state. Gather up all the action that can happen in a state machine Create a class that acts as the state machine. For each action, we create a method that uses conditional statements to determine what behavior is appropriate in each state. Example Lets check how these steps are followed in case of simple gate in metro or subway\nGate will have three state: Open,Close and Process Payment. Defining the states using constants and a variable to hold the current state. private final int OPEN_STATE = 0; private final int CLOSE_STATE = 1; private final int PROCESSING_STATE = 2; private int CURRENT_STATE; Checking up all actions that can happen on the gates, Enter, PayOK, PayFail and, PayInitiated. States and Action States Enter PayOK PayFail PayInitiated Open State Close Open Open Open Close State Close Close Close Processing Processing State Processing Open Close Processing For each of the action, create a conditinal to determine the next state of the gate. public void enter() { if (CURRENT_STATE == OPEN_STATE) { System.out.println(\"Individual has enter the gate, closing gate\"); CURRENT_STATE = CLOSE_STATE; } else if (CURRENT_STATE == CLOSE_STATE) { System.out.println(\"Please pay to open the gate\"); } else if (CURRENT_STATE == PROCESSING_STATE) { System.out.println(\"Payment is in process, please wait\"); } } Lets test all these behaviours out and be done with our development. Sadly we know that is not true ;). New requirements for state might come in future and we are checking for states at each action at multiple places, which can introduce buggy behaviour in the code and this is a code smell known as Repeated Switches.\nRefactoring to State pattern Before refactoring, we should have a test suite ready which we can use to verify the behaviour. We will make small changes on our way and run the suites to verify the existing behaviours.\nSteps for refactoring Step-1: Extract methods from the actions for a given state using Extract Methods. public void enter() { if (CURRENT_STATE == OPEN_STATE) { enterForOpenState(); } else if (CURRENT_STATE == CLOSE_STATE) { System.out.println(\"Please pay to open the gate\"); } else if (CURRENT_STATE == PROCESSING_STATE) { System.out.println(\"Payment is in process, please wait\"); } } private void enterForOpenState() { System.out.println(\"Individual has enter the gate, closing gate\"); CURRENT_STATE = CLOSE_STATE; } Step-2: Using Slide Functions aggregate all actions of a given state. private void enterForOpenState() { System.out.println(\"Individual has enter the gate, closing gate\"); CURRENT_STATE = CLOSE_STATE; } private void payOkForOpenState() { System.out.println(unreachableStep); throw new IllegalCallerException(unreachableStep); } private void payFailForOpenState() { System.out.println(unreachableStep); throw new IllegalCallerException(unreachableStep); } private void payInitiatedForOpenState() { System.out.println(\"Payment is already processed\"); } These extracted function becomes the base of the new class representing a state. We need to have an uniform interface to hold different methods to be executed by the a given state containing all actions. public interface GateState { void enter(); void payOK(); void payFail(); void payInitiated(); } Create a class for the OpenState implementing GateState and add all the functions to the that state having implementation extracted from the parent class. All our test cases will start to fail. We need a new suite of tests for verifying these changing behaviours.\nRepeat the same steps for the other GateState: CloseState and ProcessingState.\nFinally Change the Gate class having current state only, and the actions delegating their actions to the respective GateStates.\npublic class Gate { GateState gateState; public void enter() { gateState.enter(); } public void payOK() { gateState.payOK(); } public void payFail() { gateState.payFail(); } public void payInitiated() { gateState.payInitiated(); } } Advantage of Refactoring to State Pattern Localised the behaviour of a state into it’s own class. Removed the code smell Repeated Switch using polymorphism. Closed the state for modifications and let it remain for extensions, whenever a new requirement for the state arrives lets say to add Retired State or Out of Order State, code will be open for extension. Code has become easier to understand and cheaper to maintain. Source Code Code is hosted at @github, please reach out for suggestions.\nReferences Refactoring Book (https://martinfowler.com/books/refactoring.html) Code Smell (https://martinfowler.com/bliki/CodeSmell.html) Code Smell (https://en.wikipedia.org/wiki/Code_smell) State Design Pattern (https://refactoring.guru/design-patterns/state) Christopher Okhravi, State Design Pattern (https://www.youtube.com/watch?v=N12L5D78MAA) Head First Design Pattern (https://www.oreilly.com/library/view/head-first-design/0596007124/) Finite State Machine (https://en.wikipedia.org/wiki/Finite-state_machine/) ","wordCount":"1017","inLanguage":"en","datePublished":"2022-08-09T22:03:46+05:30","dateModified":"2022-08-09T22:03:46+05:30","author":[{"@type":"Person","name":"Siddhant Shaw"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://mianto.github.io/posts/refactoring-to-state-pattern/"},"publisher":{"@type":"Organization","name":"Siddhant Shaw","logo":{"@type":"ImageObject","url":"https://mianto.github.io/images/favicon.ico"}}}</script></head><body id=top><script>window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://mianto.github.io/ accesskey=h title="Siddhant Shaw (Alt + H)">Siddhant Shaw</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://mianto.github.io/about/ title=About><span>About</span></a></li><li><a href=https://mianto.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://mianto.github.io/projects/ title=Projects><span>Projects</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://mianto.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://mianto.github.io/posts/>Posts</a></div><h1 class=post-title>Refactoring to State Pattern</h1><div class=post-meta><span title='2022-08-09 22:03:46 +0530 +0530'>August 9, 2022</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Siddhant Shaw</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#state-pattern aria-label="State Pattern">State Pattern</a><ul><li><a href=#implementing-state-pattern aria-label="Implementing State Pattern">Implementing State Pattern</a></li><li><a href=#example aria-label=Example>Example</a><ul><li><a href=#states-and-action aria-label="States and Action">States and Action</a></li></ul></li></ul></li><li><a href=#refactoring-to-state-pattern aria-label="Refactoring to State pattern">Refactoring to State pattern</a><ul><li><a href=#steps-for-refactoring aria-label="Steps for refactoring">Steps for refactoring</a></li><li><a href=#advantage-of-refactoring-to-state-pattern aria-label="Advantage of Refactoring to State Pattern">Advantage of Refactoring to State Pattern</a></li></ul></li><li><a href=#source-code aria-label="Source Code">Source Code</a></li><li><a href=#references aria-label=References>References</a></li></ul></div></details></div><div class=post-content><p>Refactoring is a process of changing a software in a way that doesn&rsquo;t alter the external behaviour of code and yet improve its internal structure. Refactoring is just like performance optimization as both involve carrying out code manipulations that don’t change the overall functionality of the program. The difference is the purpose: Refactoring is always done to make the code <em>easier to understand and cheaper to modify</em>.</p><p><img loading=lazy src=../../../images/post/refactoring/refactoring_process.png alt="Refactoring Process"></p><p>Refactoring is generally done when there is tangible and observable indication that there is deeper problem in the system, these are called code smells. There is lot of code smell which includes <em>Long Method</em>, <em>Large Class</em>, which generally indicates method or class is doing more than single thing.</p><p>In this post, I am going to talk about one of the code smell <strong>Repeated Switches</strong>, and how it can be related to <strong>State design pattern</strong>. Repeat Switches occurs where the same conditional switching logic (either in a switch/case statement or in a cascade of if/else statements) pops up in different places. The problem with such duplicate switches is that, whenever a clause is added or needs to be updated, one have to find all the switches and update them.</p><h2 id=state-pattern>State Pattern<a hidden class=anchor aria-hidden=true href=#state-pattern>#</a></h2><p>State pattern allows an object to alter its behaviour when its internal state changes. The object will appear to change its class. State pattern is closely related to <em>Finite state machines</em>.</p><p><img loading=lazy src=../../../images/post/refactoring/state_machine.png alt="Finite State Machine"></p><p>The main idea is that, at any given moment, there’s a finite number of states which a program can be in. Within any unique state, the program behaves differently, and the program can be switched from one state to another instantaneously. However, depending on a current state, the program may or may not switch to certain other states. These switching rules, called transitions, are also finite and predetermined.</p><h3 id=implementing-state-pattern>Implementing State Pattern<a hidden class=anchor aria-hidden=true href=#implementing-state-pattern>#</a></h3><p>Implementing a finite state machine involves series of steps:</p><ul><li>Gather up all the states</li><li>Define the states using a constants or enums and create an instance to hold the current state.</li><li>Gather up all the action that can happen in a state machine</li><li>Create a class that acts as the state machine. For each action, we create a method that uses conditional statements to determine what behavior is appropriate in each state.</li></ul><h3 id=example>Example<a hidden class=anchor aria-hidden=true href=#example>#</a></h3><p>Lets check how these steps are followed in case of simple gate in metro or subway</p><ul><li>Gate will have three state: <code>Open</code>,<code>Close</code> and <code>Process Payment</code>.</li><li>Defining the states using constants and a variable to hold the current state.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> OPEN_STATE <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> CLOSE_STATE <span style=color:#f92672>=</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> PROCESSING_STATE <span style=color:#f92672>=</span> 2<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> CURRENT_STATE<span style=color:#f92672>;</span>
</span></span></code></pre></div><ul><li>Checking up all actions that can happen on the gates, <code>Enter</code>, <code>PayOK</code>, <code>PayFail</code> and, <code>PayInitiated</code>.</li></ul><hr><h4 id=states-and-action>States and Action<a hidden class=anchor aria-hidden=true href=#states-and-action>#</a></h4><table><thead><tr><th>States</th><th style=text-align:center>Enter</th><th style=text-align:center>PayOK</th><th style=text-align:center>PayFail</th><th style=text-align:center>PayInitiated</th></tr></thead><tbody><tr><td>Open State</td><td style=text-align:center>Close</td><td style=text-align:center>Open</td><td style=text-align:center>Open</td><td style=text-align:center>Open</td></tr><tr><td>Close State</td><td style=text-align:center>Close</td><td style=text-align:center>Close</td><td style=text-align:center>Close</td><td style=text-align:center>Processing</td></tr><tr><td>Processing State</td><td style=text-align:center>Processing</td><td style=text-align:center>Open</td><td style=text-align:center>Close</td><td style=text-align:center>Processing</td></tr></tbody></table><hr><ul><li>For each of the action, create a conditinal to determine the next state of the gate.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>enter</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>CURRENT_STATE <span style=color:#f92672>==</span> OPEN_STATE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Individual has enter the gate, closing gate&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            CURRENT_STATE <span style=color:#f92672>=</span> CLOSE_STATE<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>CURRENT_STATE <span style=color:#f92672>==</span> CLOSE_STATE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Please pay to open the gate&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>CURRENT_STATE <span style=color:#f92672>==</span> PROCESSING_STATE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Payment is in process, please wait&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Lets test all these behaviours out and be done with our development. Sadly we know that is not true ;). New requirements for state might come in future and we are checking for states at each action at multiple places, which can introduce buggy behaviour in the code and this is a code smell known as <strong>Repeated Switches</strong>.</p><h2 id=refactoring-to-state-pattern>Refactoring to State pattern<a hidden class=anchor aria-hidden=true href=#refactoring-to-state-pattern>#</a></h2><p>Before refactoring, we should have a test suite ready which we can use to verify the behaviour. We will make small changes on our way and run the suites to verify the existing behaviours.</p><h3 id=steps-for-refactoring>Steps for refactoring<a hidden class=anchor aria-hidden=true href=#steps-for-refactoring>#</a></h3><ul><li><strong>Step-1</strong>: Extract methods from the actions for a given state using <code>Extract Methods</code>.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>enter</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>CURRENT_STATE <span style=color:#f92672>==</span> OPEN_STATE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            enterForOpenState<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>CURRENT_STATE <span style=color:#f92672>==</span> CLOSE_STATE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Please pay to open the gate&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>CURRENT_STATE <span style=color:#f92672>==</span> PROCESSING_STATE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Payment is in process, please wait&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>enterForOpenState</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Individual has enter the gate, closing gate&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        CURRENT_STATE <span style=color:#f92672>=</span> CLOSE_STATE<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li><strong>Step-2</strong>: Using <code>Slide Functions</code> aggregate all actions of a given state.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>enterForOpenState</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Individual has enter the gate, closing gate&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        CURRENT_STATE <span style=color:#f92672>=</span> CLOSE_STATE<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>payOkForOpenState</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>unreachableStep<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalCallerException<span style=color:#f92672>(</span>unreachableStep<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>payFailForOpenState</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>unreachableStep<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalCallerException<span style=color:#f92672>(</span>unreachableStep<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>payInitiatedForOpenState</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Payment is already processed&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>These extracted function becomes the base of the new class representing a state. We need to have an uniform interface to hold different methods to be executed by the a given state containing all actions.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>GateState</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>enter</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>payOK</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>payFail</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>payInitiated</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li><p>Create a class for the <code>OpenState</code> implementing <code>GateState</code> and add all the functions to the that state having implementation extracted from the parent class. All our test cases will start to fail. We need a new suite of tests for verifying these changing behaviours.</p></li><li><p>Repeat the same steps for the other GateState: CloseState and ProcessingState.</p></li><li><p>Finally Change the <code>Gate</code> class having current state only, and the actions delegating their actions to the respective GateStates.</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Gate</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        GateState gateState<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>enter</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            gateState<span style=color:#f92672>.</span><span style=color:#a6e22e>enter</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>payOK</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            gateState<span style=color:#f92672>.</span><span style=color:#a6e22e>payOK</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>payFail</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            gateState<span style=color:#f92672>.</span><span style=color:#a6e22e>payFail</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>payInitiated</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            gateState<span style=color:#f92672>.</span><span style=color:#a6e22e>payInitiated</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=advantage-of-refactoring-to-state-pattern>Advantage of Refactoring to State Pattern<a hidden class=anchor aria-hidden=true href=#advantage-of-refactoring-to-state-pattern>#</a></h3><ul><li>Localised the behaviour of a state into it&rsquo;s own class.</li><li>Removed the code smell <code>Repeated Switch</code> using polymorphism.</li><li>Closed the state for modifications and let it remain for extensions, whenever a new requirement for the state arrives lets say to add <code>Retired State</code> or <code>Out of Order State</code>, code will be open for extension.</li><li>Code has become easier to understand and cheaper to maintain.</li></ul><h2 id=source-code>Source Code<a hidden class=anchor aria-hidden=true href=#source-code>#</a></h2><p>Code is hosted at <a href=https://github.com/Mianto/refactoring-to-state-pattern>@github</a>, please reach out for suggestions.</p><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li>Refactoring Book (<a href=https://martinfowler.com/books/refactoring.html>https://martinfowler.com/books/refactoring.html</a>)</li><li>Code Smell (<a href=https://martinfowler.com/bliki/CodeSmell.html>https://martinfowler.com/bliki/CodeSmell.html</a>)</li><li>Code Smell (<a href=https://en.wikipedia.org/wiki/Code_smell>https://en.wikipedia.org/wiki/Code_smell</a>)</li><li>State Design Pattern (<a href=https://refactoring.guru/design-patterns/state>https://refactoring.guru/design-patterns/state</a>)</li><li>Christopher Okhravi, State Design Pattern (<a href="https://www.youtube.com/watch?v=N12L5D78MAA">https://www.youtube.com/watch?v=N12L5D78MAA</a>)</li><li>Head First Design Pattern (<a href=https://www.oreilly.com/library/view/head-first-design/0596007124/>https://www.oreilly.com/library/view/head-first-design/0596007124/</a>)</li><li>Finite State Machine (<a href=https://en.wikipedia.org/wiki/Finite-state_machine/>https://en.wikipedia.org/wiki/Finite-state_machine/</a>)</li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>Siddhant Shaw |</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>